<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>HelpOnConfiguration/FileAttachments</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="mentalwealth/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="mentalwealth/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="mentalwealth/css/print.css">
</head>
<body>
<table>
<tr>
<td>
<img src="logo.png">
</td>
<td>
&nbsp;[<a href="FrontPage.html">FrontPage</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]
</td>
</tr>
</table>
<hr>
<div id="page">
<h1 id="title">HelpOnConfiguration/FileAttachments</h1>
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">The <a href="./HelpOnActions(2f)AttachFile.html">AttachFile action</a> enables a page to have multiple attached files. Since file uploads could be abused for DoS (Denial of Service) attacks, <tt class="backtick">AttachFile</tt> is an action that may be enabled by the wiki administrator. To do this, add "<tt class="backtick">allowed_actions&nbsp;=&nbsp;['AttachFile']</tt>" to your configuration file. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">This is all you usually need to do for configuration. <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><div><table style="color: red;"><tbody><tr>  <td><p class="line862"> <img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> <strong>Warning: if you make your attachments directly accessible via the web server, you should make sure that the web server does not execute attachments (like .php or .asp or other scripts) uploaded by evil users. If you do not know how to do that, do not configure your installation like described below or you risk making your server remotely exploitable.</strong> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line867">
<h1 id="head-5fa13e6e31eb8482ac249e8f8c27a54006f53554">How attachments are handled</h1>
<span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line874">There are two storage/retrieval models for file attachments: <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><ol type="1"><li><p class="line862">Attachments are stored "privately" and can only be retrieved via a CGI GET (via URLs like <tt class="backtick">http://myorg.org/mywiki/&lt;SomePage&gt;?action=AttachFile&amp;do=get&amp;target=filename.ext</tt>). <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span></li><li class="gap"><p class="line862">Attachments are stored into a directory directly accessible by the web server, and can thus be served directly by the webserver, without any invocation of <a href="./MoinMoin.html">MoinMoin</a> (leading to URLs like <tt class="backtick">http://myorg.org/mywikiattach/&lt;Somepage&gt;/attachments/filename.ext</tt>). <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span></li></ol><p class="line862">The first option is the default; attachments are stored in the "...mywiki/data/pages/" directory, with paths like "<tt class="backtick">...mywiki/data/pages/&lt;pagename&gt;/attachments/&lt;filename&gt;</tt>". <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><p class="line862">The <a href="./MoinMoin.html">MoinMoin</a> <em>attachments</em> configuration option allows you to move the directory structure used to store attachments to another location.  Unless you have a reason for doing so, there is no need to use a different location. Using a different location may be more work and more risk, as all the existing attachments must be copied to the new location. The following instructions are for Apache servers and assume you intend to leave the attachment files in their existing location and your original installation used the name "mywiki". <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><p class="line867">
<h1 id="head-87ad1513b752afb806ad2a597c64f8ec7e0f3347">Serving attachments directly by the web server</h1>
<span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><ul><li><p class="line891"><img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> Note that this does not work with attachments whose filenames contain non-ascii characters. <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span></li><li class="gap"><p class="line891"><img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> <strong>Note that we plan to remove that option in 2.0. Because of that and the security problems noted below, we do not recommend that option.</strong> <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></li></ul><p class="line862">The first step is to tell Apache that it has another Alias directory from which it can serve files. Review the changes you made to the httpd.conf (or commonhttpd.conf) file during the Moin<tt class="backtick"></tt>Moin installation and find the Script<tt class="backtick"></tt>Alias statement similar to the following: <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><pre>    ScriptAlias /mywiki           ".../mywiki/moin.cgi" 
<span class="anchor" id="line-35"></span></pre><span class="anchor" id="line-36"></span><p class="line862">Create an Alias statement similar to the Script<tt class="backtick"></tt>Alias statement above, replacing the <em>/mywiki</em> URI with <em>/mywikiattach/</em> and replacing <em>moin.cgi</em> with <em>data/pages/</em>. <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><pre>    Alias       /mywikiattach/    ".../mywiki/data/pages/"
<span class="anchor" id="line-39"></span></pre><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><p class="line874">Be sure to note the differences in the trailing slashes between the two statements, they must be entered exactly as shown above. If you are making this change to a running system, you must restart Apache to have the change take effect. <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line862">The second step is to tell <a href="./MoinMoin.html">MoinMoin</a> to let Apache do the work of fetching file attachments. To do this, <span class="anchor" id="line-44"></span>you need to add an <tt class="backtick">attachments</tt> option to .../mywiki/wikiconfig.py. The 'attachment' option is a dictionary of two values: <span class="anchor" id="line-45"></span><pre>attachments = {
<span class="anchor" id="line-46"></span>    'dir': '.../mywiki/data/pages',
<span class="anchor" id="line-47"></span>    'url': '/mywikiattach',
<span class="anchor" id="line-48"></span>}
<span class="anchor" id="line-49"></span></pre><span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line862">Moin<tt class="backtick"></tt>Moin must still do the work of uploading file attachments. The <em>dir</em> value above tells Moin<tt class="backtick"></tt>Moin where to store attachments; note this is the same as the path in the new Apache Alias statement but without the trailing "/". The <em>url</em> value tells Moin<tt class="backtick"></tt>Moin how to retrieve the attachments; this matches the URI in the Alias statement but again without the trailing "/". <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line867"><img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> Your attached files are now directly servable by Apache. However if you also have PHP (or ASP or any other server parsed language) installed then an attacker can upload a PHP script an then run it to exploit other local weaknesses. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line874">For example, you can disable PHP for the appropriate directory (note that it's difficult to include instructions for disabling all server parsed languages). <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line867"><span class="anchor" id="line-58"></span><pre>&lt;Directory .../mywiki/data/pages/&gt;
<span class="anchor" id="line-59"></span>    RemoveType .php .php3 .php4 .phtml
<span class="anchor" id="line-60"></span>&lt;/Directory&gt;
<span class="anchor" id="line-61"></span></pre><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><p class="line867"><img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> This only disables php stuff - you have to add everything else on your own! <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line862">After you have completed the configuration changes, test by uploading an attachment for <a href="./WikiSandBox.html">WikiSandBox</a>. Then modify the <a href="./WikiSandBox.html">WikiSandBox</a> page to display the uploaded image or download the file. If there were existing attachments before this change, verify the old attachments are still available.  Finally, review the Apache <em>access.log</em> file to verify you have a log entry showing the expected file access: <span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><ul><li><p class="line891"><em>"...GET /mywikiattach/Wiki<tt class="backtick"></tt>Sand<tt class="backtick"></tt>Box/attachments/mypix.jpg HTTP/1.1..."</em>. <span class="anchor" id="line-68"></span></li></ul><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2007-07-30 15:45
</body>
</html>
