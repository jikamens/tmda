<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>VirtualDomainsHowto</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="mentalwealth/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="mentalwealth/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="mentalwealth/css/print.css">
</head>
<body>
<table>
<tr>
<td>
<img src="logo.png">
</td>
<td>
&nbsp;[<a href="FrontPage.html">FrontPage</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]
</td>
</tr>
</table>
<hr>
<div id="page">
<h1 id="title">VirtualDomainsHowto</h1>
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867">
<h2 id="head-e6e8fd90a753b3d049939bd349d873cae7ff4ae2">tmda-ofmipd + VPopMail or VMailMgr</h2>
<span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line874">In this HOWTO I will assume you are comfortable with basic UNIX skills and understand things like UIDs, home directories and so forth. If you are not, you should get a good UNIX tutorial/reference and learn about the basics. You should definitely not try to administer something as complicated as a mail server, particularly one serving multiple domains, until you are on speaking terms with UNIX. <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h3 id="head-0666c2ae35a2bd83c1189f3b98d9c339320bcd10">1. Virtual Domains Background</h3>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">Virtual domains are a neat feature of qmail where a single UID can control all the email addresses within a given domain. VPopMail and VMailMgr are add-ons to qmail's virtual domain system that provide POP/IMAP authentication and user/password management. In VPopMail's case, a single UID can be used for all of the virtual domains on the system. <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line874">A common situation on the Internet today is that people don't read mail from shell accounts. Instead, they are running machines without a local MTA and they retrieve their mail via POP or IMAP. Thus we have mailhubs, where mail is delivered to a POP or IMAP mailbox but the individual users never log in to a shell. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line874">Both virtual domain managers (VDMs) come with a program that can authenticate a user/password combination as provided by the user's MUA. This makes it possible to set up a POP or IMAP server with authentication provided by the VDM. So by using one of the VDMs, you can have private, authenticated POP/IMAP mailboxes in one or more domains on a single mailhub. <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line874">VMailMgr implements virtual domains using a separate UID for each domain. VPopMail can do the same, but in a typical installation all virtual domains are under a single UID, often 'vpopmail'. Normal mail delivery is accomplished in either case through a .qmail-default file and a custom delivery program that is part of the VDM package. <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line874">Each of the VDMs also comes with a utility program that can provide the path to the virtual user's home directory. In VPopMail's case, the home directory is named for the user and contains the private Maildir directory. VMailMgr, on the other hand, names the maildir itself after the user account ('tim' rather than 'Maildir') and it is that maildir directory that TMDA uses as the home directory under VMailMgr. <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line874">A simple script can parse the output of these utility programs and print the virtual user's home directory. The output of the script is captured by either tmda-filter or tmda-ofmipd and used to set the $HOME environment variable. From that point on, the '~' notation in TMDA's config file and filter files will refer to the virtual user's home directory. <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line874">This means that the default settings for many of TMDA's configuration variables will work naturally in a virtual domain environment. TMDA will expect to find each user's .tmda/ directory in the $HOME directory. There is no need to set DATADIR, FILTER_INCOMING or FILTER_OUTGOING, for example, if you are satisfied with the default path settings. <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><p class="line862">Two sample scripts are provided in the tmda/contrib directory, called vpopmail-vdir.sh and vmailmgr-vdir.sh, which will work in most installations. If you wish to store your users' TMDA configuration files somewhere other than &lt;virtual_home_dir&gt;/.tmda/, you can easily write a different script. <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><p class="line867">
<h3 id="head-af764f8b786e6adf1f3a0fc14215603715b3f9b0">2. tmda-filter</h3>
<span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><p class="line874">The tmda-filter program has a command-line option for use with virtual domains. <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line867"><tt class="backtick">-S&nbsp;&lt;script&gt;</tt><br />
  <span class="anchor" id="line-30"></span><tt class="backtick">--vhome-script&nbsp;&lt;script&gt;</tt> <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line874">You give the name of the script that prints the virtual user's home directory as the argument to this option. tmda-filter will use the output of the script to set $HOME before either Defaults.py or the user's config file are loaded, thus ensuring that tilde (~) expansion refers to the correct home directory. <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line874">Because of this processing, you no longer need to explicitly specify the user's configuration file and therefore you do not need separate .qmail- and .qmail--default files. All users can be handled from the .qmail-default file installed by VPopMail or VMailMgr. Of course, if you expect that only some of your users will use TMDA, you will need to leave the .qmail-default file alone and create separate files for those users who use TMDA. <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line874">Finally, tmda-filter may be unable to find the user's home directory. For example, this will be the case for mail sent to a bogus address in the domain. If tmda-filter is unable to find the user, it will exit with a 0 return code, allowing further processing in the .qmail-* files to occur. It is recommended that you leave the DELIVERY configuration variable set to the default ('_qok_') and place the VDMs delivery program after the line that runs tmda-filter. VPopMail example: <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867"><em>.qmail-default</em><br />
 <span class="anchor" id="line-39"></span><tt class="backtick">|&nbsp;preline&nbsp;tmda-filter&nbsp;-S&nbsp;~vpopmail/bin/vpopmail-vdir.sh</tt><br />
  <span class="anchor" id="line-40"></span><tt class="backtick">|&nbsp;vdelivermail&nbsp;""&nbsp;bounce-no-mailbox&nbsp;</tt> <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867">
<h3 id="head-bd0f08d905e184b053f6c7e3c4ff349dc818c9c1">3. tmda-ofmipd</h3>
<span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><p class="line874">The tmda-ofmipd program has two command-line options to assist in running it in a virtual domain environment. The first is: <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><p class="line867"><tt class="backtick">-S&nbsp;&lt;script&gt;</tt><br />
  <span class="anchor" id="line-47"></span><tt class="backtick">--vhome-script&nbsp;&lt;script&gt;&nbsp;</tt> <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line874">This works the same way as the corresponding option for tmda-filter. Setting it to a script that prints the virtual user's home directory will cause tmda-ofmipd to set the $HOME directory before running tmda-inject to process and send the mail. <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line874">The second command line option is normally not necessary. Some Linux distributions, such as Debian, may need it, though. It is: <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line867"><tt class="backtick">-v&nbsp;&lt;path_to_qmails_virtualdomains_file&gt;</tt><br />
  <span class="anchor" id="line-54"></span><tt class="backtick">--vdomains-path&nbsp;&lt;path_to_qmails_virtualdomains_file&gt;&nbsp;</tt> <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line874">This is the path to qmail's 'virtualdomains' file. Qmail is normally installed in /var/qmail and 'virtualdomains' is found in /var/qmail/control/virtualdomains. This is the location that tmda-ofmipd assumes, so if this is the correct path for your system, you don't need to set this option. <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line874">Some Linux distributions place qmail in /usr/local instead. If your qmail installation is not in /var/qmail, you will need to give this option to tmda-ofmipd and specify the full pathname of the qmail 'virtualdomains' file. <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><p class="line862">The rest of this HOWTO is about tmda-ofmipd and is divided into two sections: one for <a href="#vpopmail">VPopMail</a> and one for <a href="#vmailmgr">VMailMgr</a>. Please read the appropriate one for your installation, as the configuration is somewhat different for each. <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line867">
<h3 id="head-3ff4c0dfac8f1269f0e99a1a27a789b4e0707312">4. Use of tmda-pending</h3>
<span class="anchor" id="line-63"></span><p class="line874">There are two ways of using tmda-pending: through the tmda-cgi interface, or via the command line. This section describes use of tmda-pending via the command line. <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line874">Normally, a virtual user does not have a shell account on the machine hosting the mail service. In some cases, however, you may want to be able to browse the pending queue for a user as a super-user (root, vpopmail...), or perhaps provide some kind of custom service executed as uid super-user. <span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><p class="line874">To do so, you need to run tmda-pending as follows: <span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><p class="line867"><tt class="backtick">tmda-pending&nbsp;--config-file=/path/to/virtual/user/config</tt> <span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><p class="line874">In the config file, be sure that the following is set: <span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><p class="line867"><tt class="backtick">CRYPT_KEY_FILE&nbsp;=&nbsp;"/home/vpopmail/domains/leangen.net/dleangen/.tmda/crypt_key"</tt> <span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><p class="line874">To be able to browse the contents of a message, tmda-pending needs to know how to locate a "scrolling" application. For example, to set the application to less, ensure that you set an environment variable such as follows (or whatever works on your system): <span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><p class="line867"><tt class="backtick">export&nbsp;PAGER=/usr/bin/less</tt> <span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><p class="line867"><span class="anchor" id="vpopmail"></span> <span class="anchor" id="line-80"></span>
<h3 id="head-80d27a16e50c444d7844da7ea817d31a08cd4ca8">5. VPopMail</h3>
<span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line862">All files, including the per-user TMDA configuration, filter and log files, are owned by the vpopmail user. Therefore, you should run tmda-ofmipd as the vpopmail user. <strong>Do NOT use the -u (--username) switch</strong>. If you do this, the VPopMail support will not work! <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line862">Instead, use 'su' or 'sudo' to start tmda-ofmipd as the vpopmail user. In the simplest case, as root, you can start tmda-ofmipd like this: <tt class="backtick"></tt> <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><p class="line867"><tt>#&nbsp;su&nbsp;-l&nbsp;vpopmail&nbsp;-c&nbsp;'/path/to/tmda-ofmipd&nbsp;-S&nbsp;/path/to/vpopmail-vdir.sh'</tt> <span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line874">This assumes that the vpopmail user has a login shell. It also assumes the default authentication mechanism, where tmda-ofmipd searches the /home/vpopmail/.tmda/tofmipd file. You can use any of the other authentication options (vchkpw, POP/IMAP/LDAP/etc.) and, if you use the IP-based domains option in VPopMail, you can bind to all IP addresses on the machine by specifying '-p 0.0.0.0:8025'. <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><p class="line874">For each user, be sure to create a .tmda/ subdirectory in the directory printed by the --vhome-script. In a normal VPopMail/TMDA installation, this will typically be: <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><p class="line867"><tt class="backtick">/home/vpopmail/domains/example.com/&lt;username&gt;/.tmda&nbsp;</tt> <span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line874">Then, run tmda-keygen for each user, placing the generated key in .tmda/crypt_key as usual. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line874">Alternately, TMDA can be automatically added to VPopMail accounts using the vadduser-tmda script. Installation and usage instructions are listed in the top of the script, which can be found in the contrib directory of the TMDA source. <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line874">If you are satisfied with TMDA's default file locations for filters, you can create a simple /etc/tmdarc and avoid creating and maintaining individual user .tmda/config files. Here's an example: <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><p class="line867"><em>/etc/tmdarc</em><br />
 <span class="anchor" id="line-101"></span><tt class="backtick">import&nbsp;os</tt><br />
 <span class="anchor" id="line-102"></span><tt class="backtick">BARE_APPEND&nbsp;=&nbsp;"~/.tmda/whitelist"</tt><br />
  <span class="anchor" id="line-103"></span><tt class="backtick">CONFIRM_APPEND&nbsp;=&nbsp;"~/.tmda/whitelist"&nbsp;</tt> <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line874">Finally, create an outgoing filter file, '~/.tmda/filters/outgoing'. The default outgoing action is 'dated'. You may want to use a default of 'bare'. You can either set ACTION_OUTGOING to 'bare' in the user's config or /etc/tmdarc or you can tag the messages in the outgoing filter. A simple filter allowing the user to receive bounces and using the latter technique to leave the user's From: header untagged might look something like this: <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line867"><em>~/.tmda/filters/outgoing</em>: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line867"><tt class="backtick">to-file&nbsp;~/.tmda/whitelist&nbsp;bare</tt><br />
  <span class="anchor" id="line-110"></span><tt class="backtick">to&nbsp;*&nbsp;tag&nbsp;envelope&nbsp;dated=10d&nbsp;from&nbsp;bare&nbsp;</tt> <span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><p class="line874">This will cause email to all addresses in the whitelist to be sent with a 'bare' From: header field. Unknown address will also be sent with a 'bare' From: field and will tag the envelope sender with a dated address so that bounces do not get stuck in the pending queue. <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line867"><span class="anchor" id="vmailmgr"></span> <span class="anchor" id="line-115"></span>
<h3 id="head-baae495d159636fc488fc49aa5081536f8ab14d9">6. VMailMgr</h3>
<span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><p class="line874">Since each virtual domain is under the control of a different system UID in the VMailMgr model, you should run tmda-ofmipd as root, so that it can setuid to the correct user before running tmda-inject. A typical command line might be:  <span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><p class="line867"><tt>#&nbsp;/path/to/tmda-ofmipd&nbsp;-S&nbsp;/path/to/vmailmgr-vdir.sh</tt> <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><p class="line874">This assumes the default authentication mechanism, where tmda-ofmipd searches the /etc/tofmipd file. You can use any of the other authentication options (checkvpw, POP/IMAP/LDAP/etc.) and, if you use IP-based domains, you can bind to all IP addresses on the machine by specifying '-p 0.0.0.0:8025'. <span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><p class="line874">In a VMailMgr configuration, the system user that controls the virtual domain has a home directory, e.g. for a username of 'example.com', the home directory might be /home/example.com. In that directory is a users/ subdirectory that contains a maildir for each user with the same name as the user's email address: for instance, /home/example.com/users/tim. As mentioned above, the directory that tmda-ofmipd considers to be the user's home directory is the actual maildir. <span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><p class="line874">For each user, be sure to create a .tmda subdirectory in the directory printed by the --vhome-script. In a typical VMailMgr/TMDA installation, this might be: <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><p class="line867"><tt class="backtick">&nbsp;/home/example.com/users/&lt;username&gt;/.tmda&nbsp;</tt> <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><p class="line862">Then, run tmda-keygen for each user, placing the generated key in users/&lt;username&gt;/.tmda/crypt_key as usual. <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><p class="line874">If you are satisfied with TMDA's default file locations for filters, you can use a simple /etc/tmdarc and avoid creating and maintaining individual user .tmda/config files. Here's an example: <span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><p class="line867"><em>/etc/tmdarc</em>: <span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><p class="line867"><tt class="backtick">import&nbsp;os</tt><br />
 <span class="anchor" id="line-136"></span><tt class="backtick">BARE_APPEND&nbsp;=&nbsp;"~/.tmda/whitelist"</tt><br />
  <span class="anchor" id="line-137"></span><tt class="backtick">CONFIRM_APPEND&nbsp;=&nbsp;"~/.tmda/whitelist"&nbsp;</tt> <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line874">Finally, create an outgoing filter file, '~/.tmda/filters/outgoing'. The default outgoing action is 'dated'. You may want to use a default of 'bare'. You can either set ACTION_OUTGOING to 'bare' in the user's config or /etc/tmdarc or you can tag the messages in the outgoing filter. A simple filter allowing the user to receive bounces and using the latter technique to leave the user's From: header untagged might look something like this: <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line867"><em>~/.tmda/filters/outgoing</em>: <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><p class="line867"><tt class="backtick">to-file&nbsp;~/.tmda/whitelist&nbsp;bare</tt><br />
  <span class="anchor" id="line-144"></span><tt class="backtick">to&nbsp;*&nbsp;tag&nbsp;envelope&nbsp;dated=10d&nbsp;from&nbsp;bare&nbsp;</tt> <span class="anchor" id="line-145"></span><span class="anchor" id="line-146"></span><p class="line874">This will cause email to all addresses in the whitelist to be sent with a 'bare' From: header field. Unknown address will also be sent with a 'bare' From: field and will tag the envelope sender with a dated address so that bounces do not get stuck in the pending queue. <span class="anchor" id="line-147"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2007-07-30 15:45
</body>
</html>
