<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>HelpOnInstalling/ApacheWithModPython</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="mentalwealth/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="mentalwealth/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="mentalwealth/css/print.css">
</head>
<body>
<table>
<tr>
<td>
<img src="logo.png">
</td>
<td>
&nbsp;[<a href="FrontPage.html">FrontPage</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]
</td>
</tr>
</table>
<hr>
<div id="page">
<h1 id="title">HelpOnInstalling/ApacheWithModPython</h1>
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li><a href="#head-4e6235e8e3535359b4aa9df9722961dfd62a685a">Why Use mod_python</a></li><li><a href="#head-52f515a2448d32357136b23a188dd227330baeb2">Basic configuring</a><ol><li><a href="#head-8cd6758d1fcc77b433f6584bcc34e24469568d75">Install mod_python</a></li><li><a href="#head-671adcfb8441deb9daa6ba877d59cc69d5e9d25e">Set up a wiki instance</a></li><li><a href="#head-08923628c7a5b449b5f210251334c431791adec9">Edit `wikiconfig.py`</a></li><li><a href="#head-b628477f88ab294636a22af4ee665656a8897b3a">Changes to Apache `httpd.conf`</a></li></ol><li><a href="#head-2dba68d0d0ad069f1c4a2a46bcdbd07cb21d3887">Solving problems for non-root-mounted wikis</a></li><li><a href="#head-e7e935fbfb5a81ceb0698ef82b5b7a897aa5e157">Configuring root wiki</a></li><li><a href="#head-53a11a51ff1c262df8f1f287084f8700685446d4">Older mod_python versions</a><ol><li><a href="#head-7b2283d5184932488fe551b2cee08e28fb18230c">Use a wrapper script</a></li><li><a href="#head-f2a32b29f0aff0101a91c87d692d063a6e0a4ec2">Fix mod_python</a></li></ol><li><a href="#head-17313e33f7320af70773f484730b290d86b62ee5">Troubleshooting</a></li></ol></div><p class="line874"> <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867">
<h1 id="head-4e6235e8e3535359b4aa9df9722961dfd62a685a">1. Why Use mod_python</h1>
<span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line867"><a class="http" href="http://modpython.org/">mod_python</a> embeds the python interpreter into <span class="anchor" id="line-12"></span>the apache server. This saves initialization time and the need of <span class="anchor" id="line-13"></span>forking cgi scripts. It doesn't have the ability to run as different <span class="anchor" id="line-14"></span>users. It will always run as the main apache user and group. Be sure <span class="anchor" id="line-15"></span>that your wiki data files are accessible and writable by your apache <span class="anchor" id="line-16"></span>server. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line867"><img alt="&lt;!&gt;" height="15" src="./mentalwealth/img/attention.png" title="&lt;!&gt;" width="15" /> The basic configuration is suitable for mod_python 3.1.3 and later. If you use older version, see the section "Older mod_python versions" <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line867"><img alt="&lt;!&gt;" height="15" src="./mentalwealth/img/attention.png" title="&lt;!&gt;" width="15" /> mod_python will cause your apache processes to increase their <span class="anchor" id="line-21"></span>memory requirements considerably - especially as apache runs many <span class="anchor" id="line-22"></span>separate processes which will each need to have their own copy of the <span class="anchor" id="line-23"></span>python code and data in the process memory space.  You may find that <span class="anchor" id="line-24"></span>FastCGI, as detailed in <a class="nonexistent" href="./HelpOnInstalling(2f)ApacheWithFastCgi.html">HelpOnInstalling/ApacheWithFastCgi</a> is rather <span class="anchor" id="line-25"></span>more efficient in this respect. <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><p class="line867">
<h1 id="head-52f515a2448d32357136b23a188dd227330baeb2">2. Basic configuring</h1>
<span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><ol type="1"><li>Install mod_python <span class="anchor" id="line-30"></span></li><li>Set up a wiki instance <span class="anchor" id="line-31"></span></li><li><p class="line862">Edit <tt class="backtick">wikiconfig.py</tt> <span class="anchor" id="line-32"></span></li><li><p class="line862">Changes to Apache <tt class="backtick">httpd.conf</tt> <span class="anchor" id="line-33"></span></li><li>Restart Apache <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span></li></ol><p class="line862">The sample configurations below are for a wiki instance called <tt class="backtick">mywiki</tt> installed in a directory <tt class="backtick">/var/www/moin/mywiki</tt> with the main <a href="./MoinMoin.html">MoinMoin</a> installation installed in python's default site library path. The wiki appears as URL <tt class="backtick">/mywiki</tt> under the server - ie <tt class="backtick">http://my.ser.ver/mywiki</tt>.  You will need to change these to reflect your installation. <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><p class="line867">
<h2 id="head-8cd6758d1fcc77b433f6584bcc34e24469568d75">2.1. Install mod_python</h2>
<span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><p class="line862">Most people will just add a <tt class="backtick">mod_python</tt> package to their current operating system installation.  If you are building from source then you should consult the <a class="http" href="http://modpython.org/live/current/doc-html/">mod_python documentation</a>. <span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><p class="line862">The mod_python installation should have added some lines to the Apache configuration file - either in the file itself or in an included configuration file (for example on Red Hat or Fedora linux the mod_python configuration is in <tt class="backtick">/etc/httpd/conf.d/python.conf</tt>). <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line862">Make sure you have this line in <tt class="backtick">httpd.conf</tt> or mod_python will not work: <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><pre>LoadModule python_module modules/mod_python.so
<span class="anchor" id="line-46"></span></pre><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><p class="line874">After this restart Apache and make sure that it starts successfully, and that the error log has a line similar to this:- <span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><pre>[Sat Jan 01 15:40:49 2005] [notice] mod_python: Creating 4 session mutexes based on 150 max processes and 0 max threads.
<span class="anchor" id="line-51"></span></pre><span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line874">You may need to change some environment variables on (eg) FreeBSD - this is detailed in the port installation message. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line867">
<h2 id="head-671adcfb8441deb9daa6ba877d59cc69d5e9d25e">2.2. Set up a wiki instance</h2>
<span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line862">This is done as shown in <a href="./HelpOnInstalling(2f)WikiInstanceCreation.html">WikiInstanceCreation</a>. Its recommended to first configure the wiki with cgi and check that it works, then change the configuratin to use mod_python. This allows you be sure that any problems are in the mod_python transition rather than the basic <a href="./MoinMoin.html">MoinMoin</a> installation. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><ol type="1"><li>Copy moin.cgi into your wiki directory <span class="anchor" id="line-60"></span></li><li><p class="line862">Configure <tt class="backtick">httpd.conf</tt> as cgi first: <span class="anchor" id="line-61"></span><ul><li style="list-style-type:none"><span class="anchor" id="line-62"></span><pre>Alias /wiki/ "/usr/share/moin/htdocs/"
<span class="anchor" id="line-63"></span>ScriptAlias /mywiki "/var/www/moin/mywiki/moin.cgi"
<span class="anchor" id="line-64"></span></pre><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span></li></ul></li></ol><p class="line874">Restart Apache and make test that your wiki works. <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line867">
<h2 id="head-08923628c7a5b449b5f210251334c431791adec9">2.3. Edit `wikiconfig.py`</h2>
<span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line874">Make sure you use only absolute paths - relative paths will not work! <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><pre>data_dir = '/var/www/moin/mywiki/data/'
<span class="anchor" id="line-73"></span>data_underlay_dir = '/var/www/moin/mywiki/underlay/'
<span class="anchor" id="line-74"></span></pre><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">If you do not want to use absolute paths, you can use Python's os module to construct the relative paths: <span class="anchor" id="line-77"></span><pre>import os 
<span class="anchor" id="line-78"></span>data_dir = os.path.join(os.path.dirname(__file__), 'data/')
<span class="anchor" id="line-79"></span>data_underlay_dir = os.path.join(os.path.dirname(__file__), 'underlay/')
<span class="anchor" id="line-80"></span></pre><span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line874">Test that the wiki works after this change. <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><ul><li style="list-style-type:none"><p class="line891"><img alt="(!)" height="15" src="./mentalwealth/img/idea.png" title="(!)" width="15" /> In 1.2 and earlyer, the configuration file is called <tt class="backtick">moin_config.py</tt>. <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span></li></ul><p class="line867">
<h2 id="head-b628477f88ab294636a22af4ee665656a8897b3a">2.4. Changes to Apache `httpd.conf`</h2>
<span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line874">After your wiki is running as cgi script, convert it to run with mod_python.  <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><p class="line862">If you run your wiki as cgi as we recommended before, remove or comment the <a class="nonexistent" href="./ScriptAlias.html">ScriptAlias</a> directive: <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><pre>#ScriptAlias /mywiki "/var/www/moin/mywiki/moin.cgi"
<span class="anchor" id="line-93"></span></pre><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><p class="line862">Add a <tt class="backtick">Location</tt> directive: <span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><pre>&lt;Location /mywiki&gt;
<span class="anchor" id="line-98"></span>    SetHandler python-program
<span class="anchor" id="line-99"></span>    # Add the path of your wiki directory
<span class="anchor" id="line-100"></span>    PythonPath "['/var/www/moin/mywiki'] + sys.path"
<span class="anchor" id="line-101"></span>    PythonHandler MoinMoin.request::RequestModPy.run
<span class="anchor" id="line-102"></span>&lt;/Location&gt;
<span class="anchor" id="line-103"></span></pre><span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line862">If you have multiple <a href="./MoinMoin.html">MoinMoin</a> instances then add one location directive for each one (changing the paths as appropriate) and add a line with the directive <tt class="backtick">PythonInterpreter&nbsp;mywiki</tt> to each Location section. With this directive different subinterpreters with completely separate namespaces will be used for each wiki (see <a class="http" href="http://modpython.org/live/current/doc-html/pyapi-interps.html">here</a> for details). <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line862">If you did not install <a href="./MoinMoin.html">MoinMoin</a> in the default location, you will have to add the path to <a href="./MoinMoin.html">MoinMoin</a> to the system path: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><pre>    PythonPath "['/var/www/moin/mywiki', '/prefix/lib/python2.x/site-packages'] + sys.path"
<span class="anchor" id="line-110"></span></pre><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><p class="line874">Restart Apache - everything should now work correctly. <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line867">
<h1 id="head-2dba68d0d0ad069f1c4a2a46bcdbd07cb21d3887">3. Solving problems for non-root-mounted wikis</h1>
<span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><ul><li style="list-style-type:none"><p class="line891"><img alt="/!\" height="15" src="./mentalwealth/img/alert.png" title="/!\" width="15" /> If your wiki does not have a root URL (like <tt class="backtick">http://www.example.com/FrontPage</tt>), then you might need to follow the next steps: <span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span></li></ul><p class="line862">On some installations, mod_python hands <a href="./MoinMoin.html">MoinMoin</a> incorrect script_name and path_info. It usually happens when using the Apache Location directive, with a wiki in an arbitary path: <span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><pre>&lt;Location /farm/mywiki&gt;
<span class="anchor" id="line-121"></span>    ...
<span class="anchor" id="line-122"></span>&lt;/Location&gt;
<span class="anchor" id="line-123"></span></pre><span class="anchor" id="line-124"></span><p class="line874">This will not work, because its not clear what is the script name, since with location setup, there is no real script. <span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><p class="line862">To solve this problem, use a <tt class="backtick">PythonOption</tt> directive: <span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><pre>&lt;Location /farm/mywiki&gt;
<span class="anchor" id="line-129"></span>    # Location value must match the Apache Location value!
<span class="anchor" id="line-130"></span>    PythonOption Location /farm/mywiki
<span class="anchor" id="line-131"></span>    ...
<span class="anchor" id="line-132"></span>&lt;/Location&gt;
<span class="anchor" id="line-133"></span></pre><span class="anchor" id="line-134"></span><ul><li style="list-style-type:none"><p class="line891"><img alt="(!)" height="15" src="./mentalwealth/img/idea.png" title="(!)" width="15" /> New in release 1.3.5 <span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span></li></ul><p class="line867">
<h1 id="head-e7e935fbfb5a81ceb0698ef82b5b7a897aa5e157">4. Configuring root wiki</h1>
<span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><p class="line862">You may wish to have your wiki appearing at the root of your webserver - for example so that <tt class="backtick">http://wiki.example.com/</tt> will map to your wiki rather than having to use <tt class="backtick">http://wiki.example.com/mywiki/</tt>.  This requires a slightly different form of configuration using <tt class="backtick">mod_rewrite</tt> - this is a standard module of recent Apache distributions, and is often enabled by default. <span class="anchor" id="line-139"></span><span class="anchor" id="line-140"></span><p class="line862">You need to set up your wiki instance as described above, and also copy <tt class="backtick">moinmodpy.py</tt> from the Moin installation directory to the wiki instance directory (<tt class="backtick">/var/www/moin/mywiki</tt> in these examples). <span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span><p class="line862">The Apache configuration needs <tt class="backtick">mod_rewrite</tt> enabled - so the line <span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span><pre>LoadModule rewrite_module modules/mod_rewrite.so
<span class="anchor" id="line-145"></span></pre><span class="anchor" id="line-146"></span><p class="line862">should appear in the first part of the <tt class="backtick">httpd.conf</tt> configuration file. <span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><p class="line874">The wiki and virtual host configuration sould look like this:- <span class="anchor" id="line-149"></span><span class="anchor" id="line-150"></span><pre>&lt;VirtualHost *:80&gt;
<span class="anchor" id="line-151"></span>  ServerAdmin postmaster@example.com
<span class="anchor" id="line-152"></span>  DocumentRoot /var/www/html
<span class="anchor" id="line-153"></span>  ServerName wiki.example.com
<span class="anchor" id="line-154"></span>  Alias /wiki/ "/usr/share/moin/htdocs/"
<span class="anchor" id="line-155"></span>
<span class="anchor" id="line-156"></span>  # Rewrite urls
<span class="anchor" id="line-157"></span>  RewriteEngine On
<span class="anchor" id="line-158"></span>  RewriteLogLevel 0
<span class="anchor" id="line-159"></span>  # map /wiki static files to Moin htdocs
<span class="anchor" id="line-160"></span>  RewriteRule ^/wiki/(.*)$ /usr/share/moin/htdocs/$1 [last]
<span class="anchor" id="line-161"></span>  RewriteRule ^/robots.txt$ /usr/share/moin/htdocs/robots.txt [last]
<span class="anchor" id="line-162"></span>  RewriteRule ^/favicon.ico$ /usr/share/moin/htdocs/favicon.ico [last]
<span class="anchor" id="line-163"></span>  # map everything else to server script
<span class="anchor" id="line-164"></span>  RewriteRule ^(.*)$ /var/www/moin/mywiki/moinmodpy.py$1
<span class="anchor" id="line-165"></span>
<span class="anchor" id="line-166"></span>  &lt;Directory "/var/www/moin/testwiki"&gt;
<span class="anchor" id="line-167"></span>    # Modpy stuff
<span class="anchor" id="line-168"></span>    AddHandler python-program .py
<span class="anchor" id="line-169"></span>    # Add the path to the wiki directory, where
<span class="anchor" id="line-170"></span>    # moinmodpy.py and wikiconfig.py are located.
<span class="anchor" id="line-171"></span>    PythonPath "['/var/www/moin/mywiki'] + sys.path"
<span class="anchor" id="line-172"></span>    PythonHandler moinmodpy
<span class="anchor" id="line-173"></span>  &lt;/Directory&gt;
<span class="anchor" id="line-174"></span>&lt;/VirtualHost&gt;
<span class="anchor" id="line-175"></span></pre><span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><p class="line862">Apache should be restarted, and the FrontPage of <tt class="backtick">mywiki</tt> should now appear at <tt class="backtick">http://wiki.example.com/</tt>. <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span><p class="line862">Other ways of handling root level wikis with Apache are detailed in the appropriately named <a href="./HelpOnConfiguration(2f)ApacheVoodoo.html">HelpOnConfiguration/ApacheVoodoo</a>. <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span><p class="line867">
<h1 id="head-53a11a51ff1c262df8f1f287084f8700685446d4">5. Older mod_python versions</h1>
<span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span><p class="line862">mod_python versions 2.7.10, 3.0.4 and 3.1.2b have a bug in <tt class="backtick">apache.resolve_object</tt>. This bug was reported to the mod_python <span class="anchor" id="line-184"></span>maintainers and has been fixed in the 3.1.3 release. The best fix for this is to update to the current release. However if you are unable to do this there are 2 possible solutions: <span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span><p class="line867">
<h2 id="head-7b2283d5184932488fe551b2cee08e28fb18230c">5.1. Use a wrapper script</h2>
<span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><p class="line867"><a href="./MoinMoin.html">MoinMoin</a> come with a <tt class="backtick">moinmodpy.py</tt> wrapper script, and this could be used by changing the <tt class="backtick">PythonPath</tt> and <tt class="backtick">PythonHandler</tt> directives as shown in the <tt class="backtick">moinmodpy.htaccess</tt> file. The wrapper was named <tt class="backtick">moin_modpy.py</tt> in <a href="./MoinMoin.html">MoinMoin</a> 1.2. <span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><p class="line867">
<h2 id="head-f2a32b29f0aff0101a91c87d692d063a6e0a4ec2">5.2. Fix mod_python</h2>
<span class="anchor" id="line-191"></span><p class="line874">mod_python has a small resolver bug in versions 2.7.10, 3.0.4 and 3.1.2b. <span class="anchor" id="line-192"></span>The method <tt class="backtick">resolve_object</tt> in <tt class="backtick">mod_python/apache.py</tt> checks the wrong <span class="anchor" id="line-193"></span>object, and so the lookup for <tt class="backtick">RequestModPy.run</tt> fails. <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><p class="line862">To fix it you need to change the method <tt class="backtick">resolve_object</tt> (around line 551 for <span class="anchor" id="line-196"></span>mod_python 3.1.2b) from <span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><p class="line867"><span class="anchor" id="line-199"></span><pre>        if silent and not hasattr(module, obj_str):
<span class="anchor" id="line-200"></span>            return None
<span class="anchor" id="line-201"></span></pre><span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><p class="line874">to <span class="anchor" id="line-204"></span><span class="anchor" id="line-205"></span><p class="line867"><span class="anchor" id="line-206"></span><pre>        if silent and not hasattr(obj, obj_str):
<span class="anchor" id="line-207"></span>            return None
<span class="anchor" id="line-208"></span></pre><span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span><p class="line867">
<h1 id="head-17313e33f7320af70773f484730b290d86b62ee5">6. Troubleshooting</h1>
<span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span><p class="line874">Page access gives apache error:: <span class="anchor" id="line-214"></span><ul><li style="list-style-type:none"><p class="line891"><tt>PythonHandler&nbsp;MoinMoin.request::RequestModPy.run:&nbsp;OSError:&nbsp;[Errno&nbsp;2]&nbsp;No&nbsp;such&nbsp;file&nbsp;or&nbsp;directory:&nbsp;'data/user'</tt> <span class="anchor" id="line-215"></span>This appears to be caused by you not having an absolute path for <tt class="backtick">data_dir</tt> in <tt class="backtick">moin_config.py</tt>.  There are several other lines of error traceback preceding this one in the apache error log.  Fix the path in <tt class="backtick">moin_config.py</tt>. <span class="anchor" id="line-216"></span></li></ul><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2007-07-30 15:45
</body>
</html>
