<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>PreConfiguration</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="mentalwealth/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="mentalwealth/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="mentalwealth/css/print.css">
</head>
<body>
<table>
<tr>
<td>
<img src="logo.png">
</td>
<td>
&nbsp;[<a href="FrontPage.html">FrontPage</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]
</td>
</tr>
</table>
<hr>
<div id="page">
<h1 id="title">PreConfiguration</h1>
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867">
<h4 id="head-3989a95dc262b58ada4b27df09dcf993bf206c46">TMDA Pre-Configuration</h4>
<span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
<h5 id="head-06af369ca42ad52ceb5b3f5b356635a8166bd1a6">MTA Configuration</h5>
<span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line862">You may need to make some system-wide configuration changes to your MTA software depending on which one you are running. First read the <a href="#general">General Prerequisites</a> section, and then read the set of instructions corresponding to your MTA: <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">[ <a href="#qmail">qmail/Courier</a> | <a href="#postfix">Postfix</a> | <a href="#exim">Exim</a> | <a href="#sendmail">Sendmail</a> ]  <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line867"><span class="anchor" id="general"></span> <span class="anchor" id="line-12"></span>
<h5 id="head-d2611d632e17cc1d923c234e9c37b5f5ba08f8e8">General Prerequisites</h5>
<span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><p class="line867"><span class="u">Extension Addresses</span> <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line862">TMDA is heavily based on user "extension addresses" (e.g, <a class="mailto" href="mailto:username+extension@yourdomain.dom">username+extension@yourdomain.dom</a>), and your MTA must be able to understand them. Some of the supported MTAs do by default, others must be configured to do so. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line862">The character that separates the username from the extension in an extension address is often called the "recipient delimiter". The most popular choices are <tt class="backtick">'''+'''</tt> and <tt class="backtick">'''-'''</tt>, although the <a class="http" href="http://wiki.tmda.net/TmdaFaq#head-93eda22a9533714e4d93da9e7bac60df959bf8f6">hyphen is recommended</a>. TMDA can support any recipient delimiter character though, just make sure you use the same character for your <strong>RECIPIENT_DELIMITER</strong> setting in <strong>~/.tmda/config</strong>. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line867"><span class="u">Environment Variables</span> <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line862">TMDA receives much of its information about the envelope of an incoming message from environment variables set by the MTA. Most importantly, <strong>SENDER</strong> (the full envelope sender address), <strong>RECIPIENT</strong> (the full envelope recipient address), and <strong>EXT</strong> or <strong>EXTENSION</strong> (the recipient address extension). In order to be reliable, TMDA needs these <em>real</em> sender and recipient values. It can't rely on what might be in the To: or From: headers. <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line874">To use TMDA, you must make sure these variables are properly set by the time TMDA sees the message. TMDA expects these variables to be in the following format: <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line867"><span class="anchor" id="line-27"></span><pre>SENDER=sender@somedomain.dom
<span class="anchor" id="line-28"></span>RECIPIENT=recipient+foo@yourdomain.dom
<span class="anchor" id="line-29"></span>EXTENSION=foo</pre><span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line874">That is, just the e-mail address or recipient address extension, with no trailing or leading whitespace, or any other extraneous characters. As with extension addresses, some MTAs set these variables by default, others must be configured to do so. <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line867"><span class="anchor" id="qmail"></span> <span class="anchor" id="line-36"></span>
<h5 id="head-6bf21c74e4774a053ba24934d829896fda0cb86f">MTA Configuration (qmail and Courier)</h5>
<span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line874">No changes need to be made to your configuration in order to use TMDA. <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867"><span class="anchor" id="postfix"></span> <span class="anchor" id="line-43"></span>
<h5 id="head-e15dbb751aa4eebac41a957aba3e184e49b69371">MTA Configuration (Postfix)</h5>
<span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><ol type="1"><li><p class="line862">Enable the <strong>recipient_delimiter</strong> parameter in Postfix's <em>main.cf</em> if it isn't already. Make sure the character you choose matches <strong>RECIPIENT_DELIMITER</strong> in your <strong>~/.tmda/config</strong>. <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span></li></ol><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line867"><span class="anchor" id="exim"></span> <span class="anchor" id="line-50"></span>
<h5 id="head-fcfcb742dde05e2389a8cd1c57d5fe473fb62437">MTA Configuration (Exim)</h5>
<span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line874">Edit your Exim run time configuration file as follows. Note: These instructions assume Exim 4.x. According to the Exim homepage, Exim 3 and previous versions are now considered obsolete. If you are running Exim 3 and can't upgrade, you'll have to find an old version of this page. <span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span><p class="line867">
<h5 id="head-82e8e52336e226dd49b10cf05723c8fd1ce3b47a">MAIN CONFIGURATION</h5>
<span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><ol type="1"><li><p class="line862">TMDA uses sendmail's `-f' option to set the envelope sender address on outgoing messages. By default this option is only available to Exim's "trusted users". You can also add <strong>untrusted_set_sender = *</strong> to your Exim configuration which allows untrusted users use of the -f command line option. <br />
<br />
 If you cannot set this option for some reason, a workaround is to set <strong>MAIL_TRANSPORT = "smtp"</strong> in your ~/.tmda/config, which will cause TMDA to send mail using direct SMTP instead of the sendmail command, thus bypassing this problem. <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span></li></ol><p class="line867">
<h5 id="head-14e18339219f41f6ab51d65e1e86fca757559834">DIRECTOR/ROUTER CONFIGURATION</h5>
<span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><ol type="1"><li><p class="line862">Exim must be configured to understand extension addresses. Add the following lines to both the <strong>userforward</strong> and the <strong>localuser</strong> directors if they are not there already: <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><pre>  local_part_suffix = -*
<span class="anchor" id="line-63"></span>  # or "+*" if you prefer "user+suffix" addresses
<span class="anchor" id="line-64"></span>  local_part_suffix_optional</pre><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span></li></ol><ul><li style="list-style-type:none"><p class="line862">Make sure the character you choose matches <strong>RECIPIENT_DELIMITER</strong> in your <strong>~/.tmda/config</strong>.<br />
<br />
 You also might be interested in <a class="http" href="http://permalink.gmane.org/gmane.mail.spam.tmda.user/7268">these Exim specific instructions</a> for a server-wide TMDA setup. <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span></li></ul><p class="line867">
<h5 id="head-24326eb39dfc918ea9863a29f988b6fedd5551d5">TRANSPORTS CONFIGURATION</h5>
<span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><ol type="1"><li><p class="line862">Exim only sets the <strong>SENDER</strong> and <strong>RECIPIENT</strong> environment variables by default. You must configure it to also set <strong>EXTENSION</strong> using the <em>environment</em> pipe option.<br />
<br />
 <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span></li><li class="gap"><p class="line862">You must also have Exim add a Return-Path: header to the message which it doesn't do by default. Do this by enabling the <em>return_path_add</em> transport option. <br />
<br />
 Set <em>return_path_add</em> and <em>environment</em> as follows under the <strong>address_pipe</strong> transport: <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><pre>  address_pipe:
<span class="anchor" id="line-75"></span>    driver = pipe
<span class="anchor" id="line-76"></span>    return_fail_output
<span class="anchor" id="line-77"></span>    return_path_add
<span class="anchor" id="line-78"></span>    environment = EXTENSION=${substr_1:$local_part_suffix} </pre><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span></li></ol><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line867"><span class="anchor" id="sendmail"></span> <span class="anchor" id="line-83"></span>
<h5 id="head-194be54231c3ad2c2c43cdc9631a6435d29e2218">MTA Configuration (Sendmail)</h5>
<span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><p class="line867"><span class="u">Gripes</span> <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><ol type="1"><li><p class="line862">The main difficulty with using TMDA under Sendmail, is that Sendmail does not set any of the required environment variables as the other supported MTAs do. In fact, as hard as this is to believe, Sendmail does not provide <strong>any</strong> envelope recipient information to commands run from a .forward file. In today's complex mail environments, full envelope information in user-space is essential to support advanced applications such as TMDA. It's not an accident why all the other supported MTAs do this; it's a good idea!<br />
<br />
 If you are stuck with Sendmail and find this deficiency as troubling as I do, you might consider sending a <a class="mailto" href="mailto:sendmail-2006@support.sendmail.org">feature request</a> to the Sendmail developers asking that the full envelope information be made available to .forward invoked programs in the form of environment variables (<strong>SENDER</strong>, <strong>RECIPIENT</strong>, and <strong>EXTENSION</strong>). This should be done regardless of whether the Sendmail installation has procmail configured as its local mailer or not.<br />
<br />
 <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span></li><li class="gap"><p class="line862">Sendmail's default recipient delimiter is a plus (<strong>+</strong>) character, but unlike the other supported MTAs, Sendmail doesn't allow the administrator to change this default. You are stick with <strong>+</strong> even though this presents <a class="http" href="http://wiki.tmda.net/TmdaFaq#head-93eda22a9533714e4d93da9e7bac60df959bf8f6">problems</a> that other recipient delimiters such as <tt class="backtick">'''-'''</tt> do not have. If you find this inflexibility troubling, consider sending a <a class="mailto" href="mailto:sendmail-2006@support.sendmail.org">feature request</a> to the Sendmail developers asking that the recipient delimiter be made configurable. <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span></li></ol><p class="line867"><span class="u">Configuration</span> <span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><p class="line874">In order to use TMDA, you need some way to obtain the necessary envelope information and set the required environm <span class="anchor" id="line-94"></span>ent variables. It matters not how you do this, just as long as these variables are properly set by the time TMDA sees the message. We provide example solutions below for sites with <a class="http" href="http://www.procmail.org/">procmail</a> or <a class="http" href="http://www.flounder.net/~mrsam/maildrop/">maildrop</a> configured as the local mailer. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line867"><span class="u">Procmail</span> <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line862">If your Sendmail installation is using procmail as its local mailer, the necessary envelope information is passed as a command line argument to procmail, typically introduced by the "-a" flag. Your <strong>.procmailrc</strong> will then be able to construct the environment variables from this argument. The necessary Sendmail configuration changes are covered below, and a sample .procmail rc is given on the <a href="./ServerConfiguration.html">ServerConfiguration</a> page. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><ol type="1"><li><p class="line862">Make sure procmail is installed on your server, and then add the following rule to your <strong>sendmail.mc</strong> file if it is not already present (most Linux distributions already define this!): <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><pre>  FEATURE(`local_procmail', `/usr/bin/procmail')</pre><span class="anchor" id="line-103"></span></li><li><p class="line862">Now run <strong>sendmail.mc</strong> through <strong>m4</strong> to produce your new <strong>sendmail.cf</strong> file, and restart Sendmail so the changes will take effect. <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span></li></ol><p class="line867"><span class="u">Maildrop</span> <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line862">If your Sendmail installation is using maildrop as its local mailer, the necessary envelope information is passed as command line arguments to maildrop. Your <strong>.mailfilter</strong> will then be able to construct the environment variables from these arguments. The necessary Sendmail configuration changes are covered below, and a sample .mailfilter is given on the <a href="./ServerConfiguration.html">ServerConfiguration</a> page. <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><ol type="1"><li><p class="line862">Make sure maildrop is installed on your server, and then add the following rule to your <strong>sendmail.mc</strong> file if it is not already present: <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><pre>  FEATURE(local_procmail,`/usr/bin/maildrop',`maildrop -d $u $h $j $g')</pre><span class="anchor" id="line-112"></span></li><li><p class="line862">Now run <strong>sendmail.mc</strong> through <strong>m4</strong> to produce your new <strong>sendmail.cf</strong> file, and restart Sendmail so the changes will take effect.<br />
<br />
 <span class="anchor" id="line-113"></span></li><li>If for some reason any of your $ macros are not set properly please consult the Sendmail documentation. The example above was taken from a Redhat Linux 9 system. <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span></li></ol><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-116"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2007-07-30 15:45
</body>
</html>
